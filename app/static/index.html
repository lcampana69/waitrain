<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waitrain NL-SQL</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      textarea { width: 100%; min-height: 6rem; }
      pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; }
      table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
      th, td { border: 1px solid #ddd; padding: 0.5rem; }
      .grid { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    </style>
  </head>
  <body>
    <h1>Consultas en lenguaje natural</h1>
    <p>Realiza preguntas sobre tu base de datos PostgreSQL. El servidor generará una consulta SQL basada en el esquema detectado.</p>
    <div>
      <label for="question">Pregunta</label>
      <textarea id="question" placeholder="¿Cuántos usuarios están activos?"></textarea>
      <button id="ask">Preguntar</button>
    </div>
    <div class="grid">
      <div>
        <h2>SQL generado</h2>
        <pre id="sql">—</pre>
      </div>
      <div>
        <h2>Resumen</h2>
        <pre id="summary">—</pre>
      </div>
    </div>
    <div>
      <h2>Resultados</h2>
      <table id="results"></table>
    </div>

    <script>
      const askBtn = document.getElementById('ask');
      const questionField = document.getElementById('question');
      const sqlBlock = document.getElementById('sql');
      const summaryBlock = document.getElementById('summary');
      const resultsTable = document.getElementById('results');

      function renderTable(columns, rows) {
        if (!columns || columns.length === 0) {
          resultsTable.innerHTML = '<tr><td>No hay filas</td></tr>';
          return;
        }
        const header = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
        const body = rows.map(r => '<tr>' + r.map(v => `<td>${v}</td>`).join('') + '</tr>').join('');
        resultsTable.innerHTML = header + body;
      }

      askBtn.addEventListener('click', async () => {
        const question = questionField.value.trim();
        if (!question) return;
        sqlBlock.textContent = 'Generando...';
        summaryBlock.textContent = 'Consultando...';
        resultsTable.innerHTML = '';
        try {
          const response = await fetch('/question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ texto: question })
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.detail || 'Error desconocido');
          }

          sqlBlock.textContent = data.sql;
          summaryBlock.textContent = data.rendering.summary;
          renderTable(data.rendering.columns, data.rendering.rows);
        } catch (err) {
          sqlBlock.textContent = 'Error generando consulta';
          summaryBlock.textContent = err.message || err;
          resultsTable.innerHTML = '';
        }
      });
    </script>
  </body>
</html>
